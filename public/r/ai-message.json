{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "ai-message",
  "type": "registry:ui",
  "title": "AI Message",
  "description": "Display AI messages with markdown support and code highlighting.",
  "dependencies": ["react-markdown", "remark-gfm", "shiki", "next-themes"],
  "registryDependencies": ["button", "dropdown-menu"],
  "files": [
    {
      "path": "registry/new-york/blocks/ai/ai-message.tsx",
      "content": "\"use client\";\n\nimport { Copy, Edit, MoreVertical, RotateCcw } from \"lucide-react\";\nimport { useTheme } from \"next-themes\";\nimport React, { useEffect, useRef, useState } from \"react\";\nimport ReactMarkdown from \"react-markdown\";\nimport remarkGfm from \"remark-gfm\";\nimport { type BundledLanguage, codeToHtml } from \"shiki\";\nimport { cn } from \"@/lib/utils\";\nimport { Button } from \"@/registry/new-york/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/registry/new-york/ui/dropdown-menu\";\n\nconst STREAMING_CONFIG = {\n  CHAR_DELAY: 20,\n  BATCH_SIZE: 3,\n} as const;\n\nconst COPY_FEEDBACK_DURATION = 2000;\n\ninterface AIMessageProps {\n  content: string;\n  isStreaming?: boolean;\n  onRegenerate?: () => void;\n  onEdit?: () => void;\n  className?: string;\n  skipCodeHighlighting?: boolean;\n}\n\nfunction useStreamingText(fullText: string, isStreaming: boolean): string {\n  const [displayedText, setDisplayedText] = useState(() =>\n    isStreaming ? \"\" : fullText\n  );\n  const timeoutRef = useRef<NodeJS.Timeout | null>(null);\n\n  useEffect(() => {\n    let initialTimeoutId: NodeJS.Timeout | null = null;\n\n    if (!isStreaming) {\n      initialTimeoutId = setTimeout(() => {\n        setDisplayedText(fullText);\n      }, 0);\n      return () => {\n        if (initialTimeoutId) {\n          clearTimeout(initialTimeoutId);\n        }\n      };\n    }\n\n    if (typeof window !== \"undefined\") {\n      const prefersReducedMotion = window.matchMedia(\n        \"(prefers-reduced-motion: reduce)\"\n      ).matches;\n\n      if (prefersReducedMotion) {\n        initialTimeoutId = setTimeout(() => {\n          setDisplayedText(fullText);\n        }, 0);\n        return () => {\n          if (initialTimeoutId) {\n            clearTimeout(initialTimeoutId);\n          }\n        };\n      }\n    }\n\n    initialTimeoutId = setTimeout(() => {\n      setDisplayedText(\"\");\n    }, 0);\n    let currentIndex = 0;\n\n    const streamNext = () => {\n      if (currentIndex >= fullText.length) {\n        return;\n      }\n\n      const nextIndex = Math.min(\n        currentIndex + STREAMING_CONFIG.BATCH_SIZE,\n        fullText.length\n      );\n      setDisplayedText(fullText.slice(0, nextIndex));\n      currentIndex = nextIndex;\n\n      timeoutRef.current = setTimeout(streamNext, STREAMING_CONFIG.CHAR_DELAY);\n    };\n\n    streamNext();\n\n    return () => {\n      if (initialTimeoutId) {\n        clearTimeout(initialTimeoutId);\n      }\n      if (timeoutRef.current) {\n        clearTimeout(timeoutRef.current);\n      }\n    };\n  }, [fullText, isStreaming]);\n\n  return displayedText;\n}\n\ninterface MessageActionsProps {\n  onCopy: () => void;\n  onRegenerate?: () => void;\n  onEdit?: () => void;\n  copied: boolean;\n}\n\nfunction MessageActions({\n  onCopy,\n  onRegenerate,\n  onEdit,\n  copied,\n}: MessageActionsProps) {\n  const hasActions = onRegenerate || onEdit;\n\n  if (!hasActions) {\n    return (\n      <Button\n        aria-label=\"Copy message\"\n        className=\"opacity-0 transition-opacity duration-150 group-hover:opacity-100\"\n        onClick={onCopy}\n        variant=\"ghost\"\n      >\n        {copied ? (\n          <>\n            <Copy className=\"size-4\" />\n            <span className=\"text-xs\">Copied!</span>\n          </>\n        ) : (\n          <>\n            <Copy className=\"size-4\" />\n            <span className=\"text-xs\">Copy</span>\n          </>\n        )}\n      </Button>\n    );\n  }\n\n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button\n          aria-label=\"Message actions\"\n          className=\"opacity-0 transition-opacity duration-150 group-hover:opacity-100\"\n          size=\"icon\"\n          variant=\"ghost\"\n        >\n          <MoreVertical className=\"size-4\" />\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent align=\"end\">\n        <DropdownMenuItem onClick={onCopy}>\n          <Copy className=\"size-4\" />\n          {copied ? \"Copied!\" : \"Copy\"}\n        </DropdownMenuItem>\n        {onRegenerate && (\n          <>\n            <DropdownMenuSeparator />\n            <DropdownMenuItem onClick={onRegenerate}>\n              <RotateCcw className=\"size-4\" />\n              Regenerate\n            </DropdownMenuItem>\n          </>\n        )}\n        {onEdit && (\n          <>\n            <DropdownMenuSeparator />\n            <DropdownMenuItem onClick={onEdit}>\n              <Edit className=\"size-4\" />\n              Edit\n            </DropdownMenuItem>\n          </>\n        )}\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n}\n\ninterface HighlightedCodeBlockProps {\n  code: string;\n  language: string;\n  filename?: string;\n  skipHighlighting?: boolean;\n}\n\nfunction HighlightedCodeBlock({\n  code,\n  language,\n  filename,\n  skipHighlighting = false,\n}: HighlightedCodeBlockProps) {\n  const { theme: websiteTheme } = useTheme();\n  const [highlightedCode, setHighlightedCode] = useState<string>(\"\");\n  const [loading, setLoading] = useState(true);\n\n  const theme = websiteTheme === \"dark\" ? \"github-dark\" : \"github-light\";\n  const lang = (language || \"text\") as BundledLanguage;\n\n  useEffect(() => {\n    if (skipHighlighting) {\n      setHighlightedCode(\"\");\n      setLoading(false);\n      return;\n    }\n\n    let mounted = true;\n    setLoading(true);\n\n    const highlightCode = async () => {\n      try {\n        const html = await codeToHtml(code, {\n          lang,\n          theme,\n        });\n        if (mounted) {\n          setHighlightedCode(html);\n          setLoading(false);\n        }\n      } catch {\n        if (mounted) {\n          setHighlightedCode(\"\");\n          setLoading(false);\n        }\n      }\n    };\n\n    highlightCode();\n\n    return () => {\n      mounted = false;\n    };\n  }, [code, lang, theme, skipHighlighting]);\n\n  if (skipHighlighting) {\n    return (\n      <div className=\"rounded-lg border border-border bg-background\">\n        {filename && (\n          <div className=\"flex items-center border-border border-b bg-background px-4 py-2\">\n            <span className=\"font-mono text-muted-foreground text-sm\">\n              {filename}\n            </span>\n          </div>\n        )}\n        <pre className=\"overflow-x-auto p-4\">\n          <code className=\"wrap-break-word whitespace-pre-wrap font-mono text-sm\">\n            {code}\n          </code>\n        </pre>\n      </div>\n    );\n  }\n\n  if (loading) {\n    return (\n      <div className=\"rounded-lg border border-border bg-background\">\n        {filename && (\n          <div className=\"flex items-center border-border border-b bg-background px-4 py-2\">\n            <span className=\"font-mono text-muted-foreground text-sm\">\n              {filename}\n            </span>\n          </div>\n        )}\n        <div className=\"p-4\">\n          <div className=\"flex animate-pulse flex-col gap-2\">\n            <div className=\"h-4 rounded bg-muted\" />\n            <div className=\"h-4 w-3/4 rounded bg-muted\" />\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!highlightedCode) {\n    return (\n      <div className=\"rounded-lg border border-border bg-background\">\n        {filename && (\n          <div className=\"flex items-center border-border border-b bg-background px-4 py-2\">\n            <span className=\"font-mono text-muted-foreground text-sm\">\n              {filename}\n            </span>\n          </div>\n        )}\n        <pre className=\"overflow-x-auto p-4\">\n          <code className=\"font-mono text-sm\">{code}</code>\n        </pre>\n      </div>\n    );\n  }\n\n  function parseInlineStyle(styleText: string): React.CSSProperties {\n    const styleObject: React.CSSProperties = {};\n    for (const declaration of styleText.split(\";\")) {\n      const [prop, value] = declaration.split(\":\").map((s) => s.trim());\n      if (prop && value) {\n        const camelProp = prop.replace(/-([a-z])/g, (_m, c) => c.toUpperCase());\n        (styleObject as Record<string, string>)[camelProp] = value;\n      }\n    }\n    return styleObject;\n  }\n\n  function domNodeToReact(\n    node: ChildNode,\n    key?: string | number\n  ): React.ReactNode {\n    if (node.nodeType === Node.TEXT_NODE) {\n      return node.textContent;\n    }\n    if (node.nodeType !== Node.ELEMENT_NODE) {\n      return null;\n    }\n\n    const el = node as HTMLElement;\n    const tagName = el.tagName.toLowerCase();\n    const isCodeBlock = tagName === \"pre\" || tagName === \"code\";\n\n    const props: Record<string, any> = { key };\n\n    if (el.className) {\n      props.className = isCodeBlock\n        ? `${el.className} whitespace-pre-wrap wrap-break-word`.trim()\n        : el.className.trim();\n    } else if (isCodeBlock) {\n      props.className = \"whitespace-pre-wrap wrap-break-word\";\n    }\n\n    const styleAttr = el.getAttribute(\"style\");\n    if (styleAttr) {\n      props.style = parseInlineStyle(styleAttr);\n    }\n\n    for (const attr of el.attributes) {\n      if (attr.name.startsWith(\"data-\")) {\n        props[attr.name] = attr.value;\n      }\n    }\n\n    const children = Array.from(el.childNodes).map((child, i) =>\n      domNodeToReact(child, i)\n    );\n\n    return React.createElement(tagName, props, ...children);\n  }\n\n  const parser = new DOMParser();\n  const doc = parser.parseFromString(highlightedCode, \"text/html\");\n  const pre = doc.body.querySelector(\"pre\");\n\n  if (!pre) {\n    return (\n      <div className=\"rounded-lg border border-border bg-background\">\n        {filename && (\n          <div className=\"flex items-center border-border border-b bg-background px-4 py-2\">\n            <span className=\"font-mono text-muted-foreground text-sm\">\n              {filename}\n            </span>\n          </div>\n        )}\n        <pre className=\"overflow-x-auto p-4\">\n          <code className=\"font-mono text-sm\">{code}</code>\n        </pre>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"rounded-lg border border-border bg-background\">\n      {filename && (\n        <div className=\"flex items-center border-border border-b bg-background px-4 py-2\">\n          <span className=\"font-mono text-muted-foreground text-sm\">\n            {filename}\n          </span>\n        </div>\n      )}\n      <div className=\"overflow-x-auto\">{domNodeToReact(pre)}</div>\n    </div>\n  );\n}\n\ninterface MarkdownContentProps {\n  content: string;\n  skipCodeHighlighting?: boolean;\n}\n\nfunction MarkdownContent({\n  content,\n  skipCodeHighlighting = false,\n}: MarkdownContentProps) {\n  return (\n    <div className=\"prose prose-sm dark:prose-invert max-w-none\">\n      <ReactMarkdown\n        components={{\n          code({ node, className, children, ...props }) {\n            const match = /language-(\\w+)/.exec(className || \"\");\n            const language = match ? match[1] : \"\";\n            const codeString = String(children).replace(/\\n$/, \"\");\n\n            if (language) {\n              return (\n                <HighlightedCodeBlock\n                  code={codeString}\n                  language={language}\n                  skipHighlighting={skipCodeHighlighting}\n                />\n              );\n            }\n\n            return (\n              <code\n                className={cn(\n                  \"relative rounded bg-muted px-[0.3rem] py-[0.2rem] font-mono text-sm\",\n                  className\n                )}\n                {...props}\n              >\n                {children}\n              </code>\n            );\n          },\n          a({ href, children, ...props }) {\n            return (\n              <a\n                href={href}\n                rel=\"noopener noreferrer\"\n                target=\"_blank\"\n                {...props}\n              >\n                {children}\n              </a>\n            );\n          },\n        }}\n        remarkPlugins={[remarkGfm]}\n      >\n        {content}\n      </ReactMarkdown>\n    </div>\n  );\n}\n\nexport default function AIMessage({\n  content,\n  isStreaming = false,\n  onRegenerate,\n  onEdit,\n  className,\n  skipCodeHighlighting = false,\n}: AIMessageProps) {\n  const [copied, setCopied] = useState(false);\n  const displayedContent = useStreamingText(content, isStreaming);\n\n  const handleCopy = async () => {\n    try {\n      await navigator.clipboard.writeText(content);\n      setCopied(true);\n      setTimeout(() => setCopied(false), COPY_FEEDBACK_DURATION);\n    } catch {}\n  };\n\n  return (\n    <div className={cn(\"group relative shadow-xs\", className)}>\n      <div className=\"absolute top-0 right-0 z-10\">\n        <MessageActions\n          copied={copied}\n          onCopy={handleCopy}\n          onEdit={onEdit}\n          onRegenerate={onRegenerate}\n        />\n      </div>\n\n      <div>\n        <MarkdownContent\n          content={displayedContent}\n          skipCodeHighlighting={skipCodeHighlighting}\n        />\n        {isStreaming && (\n          <span\n            aria-hidden=\"true\"\n            className=\"inline-block h-4 w-0.5 bg-foreground motion-safe:animate-pulse\"\n          />\n        )}\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:ui"
    }
  ]
}
